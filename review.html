<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>endmysub – Reviews</title>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    :root{
      /* Palette */
      --primary:#1F3A5F;   /* Deep Blue */
      --slate:#5E7A8A;     /* Soft Slate */
      --off:#F6F8FA;       /* Off-White */
      --green:#4CAF8A;     /* Muted Green */
      --gray:#E1E5EA;      /* Warm Gray */

      /* Theme */
      --bg0:#070b13;
      --bg1:#0c1629;
      --bg2:#0a1324;

      --text:rgba(246,248,250,.96);
      --muted:rgba(246,248,250,.72);
      --line:rgba(225,229,234,.18);

      --shadow:0 18px 44px rgba(0,0,0,.42);

      --page:
        radial-gradient(1200px 720px at 15% 8%, rgba(31,58,95,.46), transparent 62%),
        radial-gradient(900px 620px at 85% 10%, rgba(94,122,138,.22), transparent 60%),
        radial-gradient(900px 640px at 45% 115%, rgba(76,175,138,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    body{
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:var(--page);
      color:var(--text);
      min-height:100vh;
    }

    header{
      background:linear-gradient(180deg, rgba(31,58,95,.48), rgba(10,19,36,.84));
      border-bottom:1px solid rgba(225,229,234,.16);
      backdrop-filter:blur(10px);
      position:sticky;top:0;z-index:20;
    }

    .h{
      max-width:1160px;
      margin:0 auto;
      padding:14px 18px;
      display:flex;
      align-items:center;
      gap:12px
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      text-decoration:none;
    }

    .logo{
      width:380px;
      height:180px;
      object-fit:contain;
      background:transparent;
      border:0;
      display:block;
      filter: drop-shadow(0 12px 26px rgba(0,0,0,.45));
    }

    .right{margin-left:auto;display:flex;gap:10px;align-items:center}

    .btn{
      border:1px solid rgba(225,229,234,.22);
      border-radius:12px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      font-family:inherit;
      text-decoration:none;
      display:inline-flex;align-items:center;justify-content:center;
      background:rgba(246,248,250,.06);
      color:var(--off);
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{background:rgba(246,248,250,.10);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{
      background:linear-gradient(180deg, rgba(76,175,138,.30), rgba(76,175,138,.18));
      border-color:rgba(76,175,138,.55);
      color:var(--off);
    }
    .btn.primary:hover{
      background:linear-gradient(180deg, rgba(76,175,138,.36), rgba(76,175,138,.22));
      border-color:rgba(76,175,138,.70);
    }
    .btn[disabled]{opacity:.6;cursor:not-allowed;transform:none}

    .wrap{max-width:1160px;margin:18px auto 50px;padding:0 18px}

    .pageGrid{
      display:grid;
      grid-template-columns: 1fr .92fr;
      gap:16px;
      align-items:start;
    }
    @media(max-width:980px){
      .pageGrid{grid-template-columns:1fr}
      .logo{width:320px;height:120px}
    }

    .card{
      background:linear-gradient(180deg, rgba(246,248,250,.06), rgba(246,248,250,.04));
      border:1px solid rgba(225,229,234,.18);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:18px
    }

    h1{font-size:26px;margin-bottom:6px;letter-spacing:-.2px}
    .sub{color:var(--muted);font-size:14px;line-height:1.45}
    .muted{font-size:12px;color:rgba(246,248,250,.66);line-height:1.35}

    .inner{
      background:rgba(7,11,19,.44);
      border:1px solid rgba(225,229,234,.14);
      border-radius:14px;
      padding:14px;
      box-shadow:none;
    }

    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    label{display:block;font-size:12px;color:rgba(246,248,250,.72);margin:12px 0 6px;font-weight:900}

    input,textarea,select{
      width:100%;
      padding:11px 12px;
      border:1px solid rgba(225,229,234,.20);
      border-radius:12px;
      font-family:inherit;
      font-size:14px;
      outline:none;
      background:rgba(7,11,19,.58);
      color:var(--off)
    }
    input:focus,textarea:focus,select:focus{
      border-color:rgba(94,122,138,.70);
      box-shadow:0 0 0 3px rgba(94,122,138,.18)
    }
    textarea{min-height:120px;resize:vertical}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}

    .stat{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .pill{
      background:rgba(31,58,95,.30);
      border:1px solid rgba(225,229,234,.18);
      color:rgba(246,248,250,.92);
      border-radius:999px;
      padding:8px 12px;
      font-weight:1000;
      font-size:13px
    }

    .list{display:grid;gap:12px;margin-top:12px}
    .rev{
      border:1px solid rgba(225,229,234,.16);
      background:rgba(7,11,19,.54);
      border-radius:14px;
      padding:14px
    }
    .revTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .stars{font-weight:1000}
    .revTitle{font-weight:1000;margin-top:6px}
    .revBody{color:rgba(246,248,250,.92);margin-top:6px;line-height:1.5}
    .revMeta{color:rgba(246,248,250,.62);font-size:12px;margin-top:8px}

    .hide{display:none}

    .warn{
      background:rgba(255, 237, 213, .10);
      border:1px solid rgba(254, 215, 170, .40);
      color:#ffd3b0;
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      line-height:1.35
    }
    .ok{
      background:rgba(76,175,138,.12);
      border:1px solid rgba(76,175,138,.22);
      color:#c6ffe9;
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      line-height:1.35
    }

    .sideCard{position:sticky;top:92px}
    @media(max-width:980px){.sideCard{position:static}}

    .promoTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap}
    .price{
      font-weight:1100;
      font-size:22px;
      letter-spacing:-.2px;
      color:var(--off);
    }
    .price small{
      font-size:12px;
      color:rgba(246,248,250,.66);
      font-weight:900;
      margin-left:6px;
    }
    .promoH{margin-top:12px;font-size:22px;font-weight:1100;letter-spacing:-.2px;line-height:1.15}
    .promoP{margin-top:8px;color:rgba(246,248,250,.72);line-height:1.55}

    .promoList{margin-top:14px;display:grid;gap:10px}
    .promoItem{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(225,229,234,.16);
      background:rgba(7,11,19,.46);
    }
    .tick{
      width:22px;height:22px;border-radius:8px;
      display:inline-flex;align-items:center;justify-content:center;
      background:rgba(76,175,138,.14);
      border:1px solid rgba(76,175,138,.22);
      color:#c6ffe9;
      font-weight:1100;
      flex:0 0 auto;
      margin-top:1px;
    }
    .promoItem b{display:block;font-weight:1100}
    .promoCta{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
    .promoFoot{margin-top:12px;color:rgba(246,248,250,.60);font-size:12px;line-height:1.35}

    footer{
      border-top:1px solid rgba(225,229,234,.14);
      background:linear-gradient(180deg, rgba(10,19,36,.40), rgba(7,11,19,.68));
      padding:26px 18px;
    }
    .footWrap{max-width:1160px;margin:0 auto}
    .footTitle{
      font-weight:1100;
      letter-spacing:.2px;
      font-size:18px;
      color:var(--off);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .footLogo{
      width:34px;
      height:34px;
      object-fit:contain;
      display:block;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.35));
    }
    .footText{margin-top:10px;color:rgba(246,248,250,.70);line-height:1.6;max-width:92ch}
    .footNav{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
    .footLink{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(225,229,234,.18);
      background:rgba(246,248,250,.06);
      color:rgba(246,248,250,.82);
      font-weight:950;
      text-decoration:none;
      transition:.15s ease;
    }
    .footLink:hover{background:rgba(246,248,250,.10);transform:translateY(-1px)}
    .footLink:active{transform:translateY(0)}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<header>
  <div class="h">
    <a class="brand" href="index.html" aria-label="">
      <img class="logo" src="endmysublogo1.png" alt="endmysub logo">
    </a>

    <div class="right">
      <button id="btnLogout" class="btn hide" type="button">Logout</button>
      <a class="btn" href="cancel.html">Cancel</a>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="pageGrid">
    <!-- LEFT -->
    <div class="leftCol">
      <div class="card">
        <h1>Customer Reviews</h1>
        <p class="sub">Login required to post reviews. Status/errors are shown below.</p>

        <div id="statusBox" class="ok" style="margin-top:12px">Ready.</div>

        <!-- LOGIN BOX -->
        <div id="loginBox" class="grid">
          <div class="inner">
            <h2 style="font-size:18px">Login / Sign up</h2>
            <p class="muted" style="margin-top:6px">Use email + password.</p>

            <label>Email</label>
            <input id="authEmail" type="email" placeholder="you@email.com">

            <label>Password</label>
            <input id="authPass" type="password" placeholder="••••••••">

            <div class="row">
              <button class="btn primary" id="btnLogin" type="button">Login</button>
              <button class="btn" id="btnSignup" type="button">Sign up</button>
            </div>

            <div class="muted" id="authMsg" style="margin-top:10px"></div>
          </div>

          <div class="inner">
            <div class="warn">
              New reviews are marked as “pending” until approved.
            </div>
            <div class="muted" style="margin-top:10px">
              If you see “Failed to fetch”, open via Live Server (http://...), not file://
            </div>
          </div>
        </div>

        <!-- APP BOX -->
        <div id="appBox" class="hide">
          <div class="stat">
            <div class="pill" id="avgPill">Avg: —</div>
            <div class="pill" id="countPill">Reviews: —</div>
            <div class="pill" id="mePill">You: —</div>
          </div>

          <div class="grid" style="margin-top:14px">
            <div class="inner">
              <h2 style="font-size:18px">Write a review</h2>

              <label>Display name</label>
              <input id="displayName" type="text" placeholder="First name or alias">

              <label>Rating</label>
              <select id="rating">
                <option value="5">5 – Excellent</option>
                <option value="4">4 – Good</option>
                <option value="3">3 – OK</option>
                <option value="2">2 – Bad</option>
                <option value="1">1 – Very bad</option>
              </select>

              <label>Title</label>
              <input id="title" type="text" placeholder="Short summary">

              <label>Review</label>
              <textarea id="body" placeholder="What was your experience?"></textarea>

              <div class="row">
                <button class="btn primary" id="btnPost" type="button">Post review</button>
                <span class="muted" id="postMsg"></span>
              </div>

              <div class="muted" style="margin-top:10px">
                Note: Your review may be pending until approved.
              </div>
            </div>

            <div class="inner">
              <h2 style="font-size:18px">Latest reviews</h2>

              <label>Filter</label>
              <select id="filter">
                <option value="all">All (approved + your pending)</option>
                <option value="approved">Approved only</option>
                <option value="mine">My reviews</option>
              </select>

              <div class="list" id="list"></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT -->
    <aside class="rightCol">
      <div class="card sideCard">
        <div class="promoTop">
          <div class="price">22,00 €<small>einmalig</small></div>
        </div>

        <div class="promoH">Kündigung ohne Stress.</div>
        <div class="promoP">
          Du gibst die Daten an. endmysub übernimmt Kündigung + Bestätigung.
        </div>

        <div class="promoList">
          <div class="promoItem"><span class="tick">✓</span><div><b>Kein Abo</b><div class="muted">Einmal zahlen. Keine Folgekosten.</div></div></div>
          <div class="promoItem"><span class="tick">✓</span><div><b>Bestätigung inklusive</b><div class="muted">Nachweis/Status-Update sobald verfügbar.</div></div></div>
          <div class="promoItem"><span class="tick">✓</span><div><b>Unabhängig</b><div class="muted">Kein Bezug zu den Anbietern. Auftrag in deinem Namen.</div></div></div>
          <div class="promoItem"><span class="tick">✓</span><div><b>Schneller Ablauf</b><div class="muted">Weniger Hin und Her. Klare Schritte.</div></div></div>
        </div>

        <div class="promoCta">
          <a class="btn primary" href="cancel.html">Jetzt kündigen</a>
          <a class="btn" href="index.html#start">Startseite</a>
        </div>

        <div class="promoFoot">
          Unabhängiger Service. Keine Rechtsberatung. Keine Verbindung zu den Anbietern.
        </div>
      </div>
    </aside>
  </div>
</div>

<footer>
  <div class="footWrap">
    <div class="footTitle">
      <img class="footLogo" src="endmysublogo1.png" alt="endmysub logo">
      endmysub
    </div>

    <div class="footText">
      Independent cancellation service. No legal advice. No affiliation with providers.
      <br><br>
      Review helps us show real results: short feedback after completion, visible quality, and better process transparency.
    </div>

    <div class="footNav" aria-label="Footer navigation">
      <a class="footLink" href="ToS.html">Nutzungsbedingungen</a>
      <a class="footLink" href="privacy.html">Datenschutz</a>
      <a class="footLink" href="impressum.html">Impressum</a>
      <a class="footLink" href="contact.html">Kontakt</a>
    </div>
  </div>
</footer>

<script>
  // ====== SUPABASE CONFIG (SET) ======
  const SUPABASE_URL = "https://babacmszcumkgzyzidnh.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhYmFjbXN6Y3Vta2d6eXppZG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MDU4NTAsImV4cCI6MjA4NDM4MTg1MH0.rRhi17MQIlE-5iJQDSYu9CENxvaHhbFyHhSct_x-QaY";
  // ===================================

  const statusBox = document.getElementById("statusBox");
  const loginBox = document.getElementById("loginBox");
  const appBox = document.getElementById("appBox");
  const btnLogout = document.getElementById("btnLogout");
  const authMsg = document.getElementById("authMsg");
  const postMsg = document.getElementById("postMsg");

  const btnLogin = document.getElementById("btnLogin");
  const btnSignup = document.getElementById("btnSignup");
  const btnPost = document.getElementById("btnPost");
  const filterEl = document.getElementById("filter");

  function setStatusOk(msg){ statusBox.className = "ok"; statusBox.textContent = msg; }
  function setStatusWarn(msg){ statusBox.className = "warn"; statusBox.textContent = msg; }

  function setBusy(on){
    btnLogin.disabled = on;
    btnSignup.disabled = on;
    if (btnPost) btnPost.disabled = on;
  }

  function setAuthedUI(user){
    const on = !!user;
    loginBox.classList.toggle("hide", on);
    appBox.classList.toggle("hide", !on);
    btnLogout.classList.toggle("hide", !on);
    const me = document.getElementById("mePill");
    if (me) me.textContent = "You: " + (user?.email || "—");
  }

  function stars(n){
    const full = "★★★★★";
    const empty = "☆☆☆☆☆";
    return full.slice(0,n) + empty.slice(0, 5-n);
  }

  function fmtDate(ts){
    try{ return new Date(ts).toLocaleString(); }catch{ return ts; }
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  if (!window.supabase){
    setStatusWarn("Supabase library not loaded. Check internet or CDN blocked.");
  }

  const sb = window.supabase ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON) : null;

  async function refreshAuth(){
    if (!sb) return;
    try{
      const { data, error } = await sb.auth.getSession();
      if (error) authMsg.textContent = error.message;
      const user = data?.session?.user || null;
      setAuthedUI(user);

      if (user){
        setStatusOk("Logged in: " + user.email);
        await loadReviews();
      } else {
        setStatusOk("Ready.");
      }
    } catch (e){
      setStatusWarn("Failed to fetch. Use Live Server (http://...), not file://");
    }
  }

  btnLogin.addEventListener("click", async () => {
    if (!sb) return;
    authMsg.textContent = "";
    setBusy(true);
    setStatusOk("Logging in...");

    const email = document.getElementById("authEmail").value.trim();
    const password = document.getElementById("authPass").value;

    try{
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error){
        authMsg.textContent = error.message;
        setStatusWarn(error.message);
      } else {
        setStatusOk("Login success.");
        setAuthedUI(data?.user || null);
        await refreshAuth();
      }
    } catch (e){
      setStatusWarn("Failed to fetch. Use Live Server (http://...), not file://");
    } finally {
      setBusy(false);
    }
  });

  btnSignup.addEventListener("click", async () => {
    if (!sb) return;
    authMsg.textContent = "";
    setBusy(true);
    setStatusOk("Creating account...");

    const email = document.getElementById("authEmail").value.trim();
    const password = document.getElementById("authPass").value;

    try{
      const { error } = await sb.auth.signUp({ email, password });
      if (error){
        authMsg.textContent = error.message;
        setStatusWarn(error.message);
      } else {
        authMsg.textContent = "Account created. Login now.";
        setStatusOk("Account created. Login now.");
      }
    } catch (e){
      setStatusWarn("Failed to fetch. Use Live Server (http://...), not file://");
    } finally {
      setBusy(false);
    }
  });

  btnLogout.addEventListener("click", async () => {
    if (!sb) return;
    setBusy(true);
    try{
      await sb.auth.signOut();
      setStatusOk("Logged out.");
      await refreshAuth();
    } finally {
      setBusy(false);
    }
  });

  filterEl.addEventListener("change", () => loadReviews());

  btnPost.addEventListener("click", async () => {
    if (!sb) return;
    postMsg.textContent = "";
    setBusy(true);

    const { data: s } = await sb.auth.getSession();
    const user = s?.session?.user;
    if (!user){ setStatusWarn("Not logged in."); setBusy(false); return; }

    const display_name = document.getElementById("displayName").value.trim() || "Customer";
    const rating = parseInt(document.getElementById("rating").value, 10);
    const title = document.getElementById("title").value.trim();
    const body = document.getElementById("body").value.trim();

    if (!title || !body) {
      postMsg.textContent = "Title and review text are required.";
      setStatusWarn("Title and review text are required.");
      setBusy(false);
      return;
    }

    try{
      const payload = { user_id: user.id, display_name, rating, title, body, approved: false };
      const { error } = await sb.from("reviews").insert(payload);

      if (error){
        postMsg.textContent = error.message;
        setStatusWarn(error.message);
      } else {
        postMsg.textContent = "Posted. Pending approval.";
        setStatusOk("Posted. Pending approval.");
        document.getElementById("title").value = "";
        document.getElementById("body").value = "";
        await loadReviews();
      }
    } finally {
      setBusy(false);
    }
  });

  async function loadReviews(){
    if (!sb) return;

    const filter = document.getElementById("filter").value;
    const list = document.getElementById("list");
    list.innerHTML = "";

    const { data: s } = await sb.auth.getSession();
    const user = s?.session?.user;

    if (!user){
      list.innerHTML = `<div class="warn">Not logged in.</div>`;
      return;
    }

    let q = sb.from("reviews")
      .select("id,user_id,display_name,rating,title,body,created_at,approved")
      .order("created_at", { ascending: false })
      .limit(50);

    if (filter === "approved") q = q.eq("approved", true);
    if (filter === "mine") q = q.eq("user_id", user.id);
    if (filter === "all") q = q.or(`approved.eq.true,user_id.eq.${user.id}`);

    const { data, error } = await q;

    if (error) {
      list.innerHTML = `<div class="warn">${escapeHtml(error.message)}</div>`;
      setStatusWarn(error.message);
      return;
    }

    const reviews = data || [];
    const approvedOnly = reviews.filter(r => r.approved);

    const avg = approvedOnly.length
      ? (approvedOnly.reduce((a,r)=>a + r.rating, 0) / approvedOnly.length).toFixed(1)
      : "—";

    document.getElementById("avgPill").textContent = "Avg: " + avg;
    document.getElementById("countPill").textContent = "Reviews: " + approvedOnly.length;

    for (const r of reviews) {
      const pending = !r.approved;
      const el = document.createElement("div");
      el.className = "rev";
      el.innerHTML = `
        <div class="revTop">
          <div>
            <div class="stars">${stars(r.rating)} <span style="font-weight:800;color:${pending ? "#ffd3b0" : "rgba(246,248,250,.66)"};font-size:12px">${pending ? "(pending)" : ""}</span></div>
            <div class="revTitle">${escapeHtml(r.title)}</div>
          </div>
          <div class="revMeta">${escapeHtml(r.display_name)} · ${escapeHtml(fmtDate(r.created_at))}</div>
        </div>
        <div class="revBody">${escapeHtml(r.body)}</div>
      `;
      list.appendChild(el);
    }

    if (reviews.length === 0) {
      list.innerHTML = `<div class="muted">No reviews yet.</div>`;
    }
  }

  if (sb){
    sb.auth.onAuthStateChange((_event, session) => {
      setAuthedUI(session?.user || null);
    });

    setStatusOk("Ready.");
    refreshAuth();
  }
</script>
</body>
</html>
