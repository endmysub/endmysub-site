<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>endmysub – Reviews</title>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    /* MATCH HOMEPAGE BACKGROUND + DARK THEME */
    :root{
      --bg:#0b1220;
      --text:#e7ecff;
      --muted:#a9b4dd;
      --line:rgba(255,255,255,.10);

      --ems-bg:
        radial-gradient(1200px 700px at 20% 10%, rgba(96,165,250,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(110,231,183,.14), transparent 55%),
        var(--bg);
    }

    body{
      font-family:Segoe UI,Arial,sans-serif;
      background:var(--ems-bg);
      color:var(--text);
    }

    header{
      background:rgba(11,18,32,.78);
      border-bottom:1px solid var(--line);
      backdrop-filter:blur(10px);
      position:sticky;top:0;z-index:20;
    }

    .h{max-width:1050px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:12px}

    .brand{display:flex;align-items:center;gap:12px;text-decoration:none}

    /* LOGO SIZE: 320x90 (same as homepage request) */
    .logo{
      width:320px;
      height:90px;
      object-fit:contain;
      border-radius:0;
      background:transparent;
      border:0;
      display:block;
      filter: drop-shadow(0 10px 28px rgba(0,0,0,.45));
    }

    .name{font-size:20px;font-weight:900;color:#c6ffe9;letter-spacing:.2px}

    .right{margin-left:auto;display:flex;gap:10px;align-items:center}
    .btn{border:1px solid rgba(255,255,255,.14);border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;font-family:inherit}
    .btn.primary{background:linear-gradient(180deg, rgba(134,239,172,.40), rgba(134,239,172,.22));color:var(--text);border-color:rgba(134,239,172,.75)}
    .btn.primary:hover{background:linear-gradient(180deg, rgba(134,239,172,.48), rgba(134,239,172,.26));border-color:rgba(134,239,172,.95)}
    .btn.secondary{background:rgba(255,255,255,.05);color:var(--text)}
    .btn.secondary:hover{background:rgba(255,255,255,.08)}

    .wrap{max-width:1050px;margin:18px auto 60px;padding:0 18px}

    .card{
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      padding:18px
    }

    h1{font-size:26px;margin-bottom:6px}
    .sub{color:var(--muted);font-size:14px;line-height:1.45}
    .grid{display:grid;grid-template-columns:1fr 1.15fr;gap:14px;margin-top:14px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}

    label{display:block;font-size:12px;color:var(--muted);margin:12px 0 6px}

    input,textarea,select{
      width:100%;padding:11px 12px;border:1px solid rgba(255,255,255,.14);border-radius:10px;
      font-family:inherit;font-size:14px;outline:none;background:rgba(255,255,255,.04);color:var(--text)
    }
    input:focus,textarea:focus,select:focus{border-color:rgba(96,165,250,.65);box-shadow:0 0 0 3px rgba(42,106,214,.14)}
    textarea{min-height:120px;resize:vertical}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .muted{font-size:12px;color:var(--muted);line-height:1.35}

    .stat{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .pill{
      background:rgba(110,231,183,.08);
      border:1px solid rgba(110,231,183,.25);
      color:#c6ffe9;
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      font-size:13px
    }

    .list{display:grid;gap:12px;margin-top:12px}

    .rev{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:14px
    }
    .revTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .stars{font-weight:900}
    .revTitle{font-weight:900;margin-top:6px}
    .revBody{color:var(--text);opacity:.92;margin-top:6px;line-height:1.45}
    .revMeta{color:var(--muted);font-size:12px;margin-top:8px}

    .hide{display:none}

    .warn{
      background:rgba(255, 237, 213, .08);
      border:1px solid rgba(254, 215, 170, .35);
      color:#ffd3b0;
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      line-height:1.35
    }
    .ok{
      background:rgba(16,185,129,.08);
      border:1px solid rgba(167,243,208,.22);
      color:#c6ffe9;
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      line-height:1.35
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<header>
  <div class="h">
    <a class="brand" href="index.html" aria-label="endmysub home">
      <img class="logo" src="endmysublogo.png" alt="endmysub logo">
      <span class="name">endmysub</span>
    </a>

    <div class="right">
      <button id="btnLogout" class="btn secondary hide">Logout</button>
      <a class="btn secondary" href="cancel.html">Cancel</a>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h1>Customer Reviews</h1>
    <p class="sub">Login required to view and post reviews.</p>

    <div id="statusBox" class="ok" style="margin-top:12px">Ready.</div>

    <div id="loginBox" class="grid">
      <div class="card" style="box-shadow:none;border-radius:14px">
        <h2 style="font-size:18px">Login / Sign up</h2>
        <p class="muted" style="margin-top:6px">Use email + password.</p>

        <label>Email</label>
        <input id="authEmail" type="email" placeholder="you@email.com">

        <label>Password</label>
        <input id="authPass" type="password" placeholder="••••••••">

        <div class="row">
          <button class="btn primary" id="btnLogin">Login</button>
          <button class="btn secondary" id="btnSignup">Sign up</button>
        </div>

        <div class="muted" id="authMsg" style="margin-top:10px"></div>
      </div>

      <div class="card" style="box-shadow:none;border-radius:14px">
        <div class="warn">
          Reviews are visible only to logged-in customers.<br>
          New reviews are marked as “pending” until approved.
        </div>
        <div class="muted" style="margin-top:10px">
          If you see “Failed to fetch”, open via Live Server (http://...), not file://
        </div>
      </div>
    </div>

    <div id="appBox" class="hide">
      <div class="stat">
        <div class="pill" id="avgPill">Avg: —</div>
        <div class="pill" id="countPill">Reviews: —</div>
        <div class="pill" id="mePill">You: —</div>
      </div>

      <div class="grid" style="margin-top:14px">
        <div class="card" style="box-shadow:none;border-radius:14px">
          <h2 style="font-size:18px">Write a review</h2>

          <label>Display name</label>
          <input id="displayName" type="text" placeholder="First name or alias">

          <label>Rating</label>
          <select id="rating">
            <option value="5">5 – Excellent</option>
            <option value="4">4 – Good</option>
            <option value="3">3 – OK</option>
            <option value="2">2 – Bad</option>
            <option value="1">1 – Very bad</option>
          </select>

          <label>Title</label>
          <input id="title" type="text" placeholder="Short summary">

          <label>Review</label>
          <textarea id="body" placeholder="What was your experience?"></textarea>

          <div class="row">
            <button class="btn primary" id="btnPost">Post review</button>
            <span class="muted" id="postMsg"></span>
          </div>

          <div class="muted" style="margin-top:10px">
            Note: Your review may be pending until approved.
          </div>
        </div>

        <div class="card" style="box-shadow:none;border-radius:14px">
          <h2 style="font-size:18px">Latest reviews</h2>

          <label>Filter</label>
          <select id="filter">
            <option value="all">All (approved + your pending)</option>
            <option value="approved">Approved only</option>
            <option value="mine">My reviews</option>
          </select>

          <div class="list" id="list"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // ====== SUPABASE CONFIG (SET) ======
  const SUPABASE_URL = "https://babacmszcumkgzyzidnh.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhYmFjbXN6Y3Vta2d6eXppZG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MDU4NTAsImV4cCI6MjA4NDM4MTg1MH0.rRhi17MQIlE-5iJQDSYu9CENxvaHhbFyHhSct_x-QaY";
  // ===================================

  const statusBox = document.getElementById("statusBox");
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  const loginBox = document.getElementById("loginBox");
  const appBox = document.getElementById("appBox");
  const btnLogout = document.getElementById("btnLogout");

  const authMsg = document.getElementById("authMsg");
  const postMsg = document.getElementById("postMsg");

  document.getElementById("filter").addEventListener("change", () => loadReviews());

  function stars(n){
    const full = "★★★★★";
    const empty = "☆☆☆☆☆";
    return full.slice(0,n) + empty.slice(0, 5-n);
  }

  function fmtDate(ts){
    try{ return new Date(ts).toLocaleString(); }catch{ return ts; }
  }

  function setAuthedUI(user){
    const on = !!user;
    loginBox.classList.toggle("hide", on);
    appBox.classList.toggle("hide", !on);
    btnLogout.classList.toggle("hide", !on);
    document.getElementById("mePill").textContent = "You: " + (user?.email || "—");
  }

  function setStatusWarn(msg){
    statusBox.className = "warn";
    statusBox.textContent = msg;
  }

  function setStatusOk(msg){
    statusBox.className = "ok";
    statusBox.textContent = msg;
  }

  async function refreshAuth(){
    try{
      const { data, error } = await sb.auth.getUser();
      if (error) authMsg.textContent = error.message;
      setAuthedUI(data?.user || null);
      if (data?.user) await loadReviews();
    } catch (e){
      setStatusWarn("Failed to fetch. Open via Live Server (http://...), not file://");
    }
  }

  document.getElementById("btnLogin").onclick = async () => {
    authMsg.textContent = "";
    const email = document.getElementById("authEmail").value.trim();
    const password = document.getElementById("authPass").value;

    try {
      const { error } = await sb.auth.signInWithPassword({ email, password });
      authMsg.textContent = error ? error.message : "Logged in.";
      await refreshAuth();
    } catch (e) {
      authMsg.textContent = "Failed to fetch. Open via Live Server (http://...), not file://";
      setStatusWarn("Failed to fetch. Open via Live Server (http://...), not file://");
    }
  };

  document.getElementById("btnSignup").onclick = async () => {
    authMsg.textContent = "";
    const email = document.getElementById("authEmail").value.trim();
    const password = document.getElementById("authPass").value;

    try {
      const { error } = await sb.auth.signUp({ email, password });
      authMsg.textContent = error ? error.message : "Account created. Login now.";
    } catch (e) {
      authMsg.textContent = "Failed to fetch. Open via Live Server (http://...), not file://";
      setStatusWarn("Failed to fetch. Open via Live Server (http://...), not file://");
    }
  };

  btnLogout.onclick = async () => {
    await sb.auth.signOut();
    await refreshAuth();
  };

  document.getElementById("btnPost").onclick = async () => {
    postMsg.textContent = "";
    const { data: u } = await sb.auth.getUser();
    const user = u?.user;
    if (!user) return;

    const display_name = document.getElementById("displayName").value.trim() || "Customer";
    const rating = parseInt(document.getElementById("rating").value, 10);
    const title = document.getElementById("title").value.trim();
    const body = document.getElementById("body").value.trim();

    if (!title || !body) {
      postMsg.textContent = "Title and review text are required.";
      return;
    }

    const payload = { user_id: user.id, display_name, rating, title, body, approved: false };

    const { error } = await sb.from("reviews").insert(payload);
    postMsg.textContent = error ? error.message : "Posted. Pending approval.";

    if (!error) {
      document.getElementById("title").value = "";
      document.getElementById("body").value = "";
      await loadReviews();
    }
  };

  async function loadReviews(){
    const filter = document.getElementById("filter").value;

    let q = sb.from("reviews")
      .select("id,user_id,display_name,rating,title,body,created_at,approved")
      .order("created_at", { ascending: false })
      .limit(50);

    if (filter === "approved") q = q.eq("approved", true);

    if (filter === "mine") {
      const { data: u } = await sb.auth.getUser();
      q = q.eq("user_id", u.user.id);
    }

    const { data, error } = await q;
    const list = document.getElementById("list");
    list.innerHTML = "";

    if (error) {
      list.innerHTML = `<div class="warn">${escapeHtml(error.message)}</div>`;
      return;
    }

    const reviews = data || [];
    const approvedOnly = reviews.filter(r => r.approved);

    const avg = approvedOnly.length
      ? (approvedOnly.reduce((a,r)=>a + r.rating, 0) / approvedOnly.length).toFixed(1)
      : "—";

    document.getElementById("avgPill").textContent = "Avg: " + avg;
    document.getElementById("countPill").textContent = "Reviews: " + approvedOnly.length;

    for (const r of reviews) {
      const pending = !r.approved;
      const el = document.createElement("div");
      el.className = "rev";
      el.innerHTML = `
        <div class="revTop">
          <div>
            <div class="stars">${stars(r.rating)} <span style="font-weight:700;color:${pending ? "#ffd3b0" : "#a9b4dd"};font-size:12px">${pending ? "(pending)" : ""}</span></div>
            <div class="revTitle">${escapeHtml(r.title)}</div>
          </div>
          <div class="revMeta">${escapeHtml(r.display_name)} · ${escapeHtml(fmtDate(r.created_at))}</div>
        </div>
        <div class="revBody">${escapeHtml(r.body)}</div>
      `;
      list.appendChild(el);
    }

    if (reviews.length === 0) {
      list.innerHTML = `<div class="muted">No reviews yet.</div>`;
    }
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  sb.auth.onAuthStateChange(() => refreshAuth());

  setStatusOk("Ready.");
  refreshAuth();
</script>
</body>
</html>
