<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>endmysub – Reviews</title>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    /* LIGHTER BACKGROUND */
    :root{
      --bg:#0f1930;          /* was #0b1220 */
      --bg2:#122043;
      --text:#e7ecff;
      --muted:#a9b4dd;
      --line:rgba(255,255,255,.12);

      --ems-bg:
        radial-gradient(1200px 700px at 20% 10%, rgba(96,165,250,.22), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(110,231,183,.18), transparent 55%),
        radial-gradient(900px 600px at 50% 110%, rgba(255,92,122,.10), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    body{
      font-family:Segoe UI,Arial,sans-serif;
      background:var(--ems-bg);
      color:var(--text);
      min-height:100vh;
    }

    header{
      background:rgba(15,25,48,.72);
      border-bottom:1px solid var(--line);
      backdrop-filter:blur(10px);
      position:sticky;top:0;z-index:20;
    }

    .h{max-width:1150px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:12px;text-decoration:none}

    .logo{
      width:320px;height:90px;object-fit:contain;background:transparent;border:0;display:block;
      filter: drop-shadow(0 10px 28px rgba(0,0,0,.45));
    }
    .name{font-size:20px;font-weight:900;color:#c6ffe9;letter-spacing:.2px}

    .right{margin-left:auto;display:flex;gap:10px;align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.16);
      border-radius:10px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      font-family:inherit;
      text-decoration:none;
      display:inline-flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,.06);
      color:var(--text);
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.09);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{
      background:linear-gradient(180deg, rgba(134,239,172,.50), rgba(134,239,172,.26));
      border-color:rgba(134,239,172,.85);
      color:#062014;
    }
    .btn.primary:hover{
      background:linear-gradient(180deg, rgba(134,239,172,.60), rgba(134,239,172,.30));
      border-color:rgba(134,239,172,1);
    }
    .btn[disabled]{opacity:.6;cursor:not-allowed;transform:none}

    .wrap{max-width:1150px;margin:18px auto 60px;padding:0 18px}

    .pageGrid{
      display:grid;
      grid-template-columns: 1fr .95fr;
      gap:14px;
      align-items:start;
    }
    @media(max-width:980px){.pageGrid{grid-template-columns:1fr}}

    .card{
      background:rgba(255,255,255,.055);              /* slightly lighter */
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      box-shadow:0 14px 34px rgba(0,0,0,.32);
      padding:18px
    }

    h1{font-size:26px;margin-bottom:6px}
    .sub{color:var(--muted);font-size:14px;line-height:1.45}
    .muted{font-size:12px;color:var(--muted);line-height:1.35}

    /* LEFT COLUMN: STACK */
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}

    label{display:block;font-size:12px;color:var(--muted);margin:12px 0 6px}

    input,textarea,select{
      width:100%;
      padding:11px 12px;
      border:1px solid rgba(255,255,255,.16);
      border-radius:10px;
      font-family:inherit;
      font-size:14px;
      outline:none;
      background:rgba(0,0,0,.14);
      color:var(--text)
    }
    input:focus,textarea:focus,select:focus{
      border-color:rgba(96,165,250,.75);
      box-shadow:0 0 0 3px rgba(42,106,214,.16)
    }
    textarea{min-height:120px;resize:vertical}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}

    .stat{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .pill{
      background:rgba(110,231,183,.10);
      border:1px solid rgba(110,231,183,.28);
      color:#c6ffe9;
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      font-size:13px
    }

    .list{display:grid;gap:12px;margin-top:12px}
    .rev{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.045);
      border-radius:14px;
      padding:14px
    }
    .revTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .stars{font-weight:900}
    .revTitle{font-weight:900;margin-top:6px}
    .revBody{color:var(--text);opacity:.92;margin-top:6px;line-height:1.45}
    .revMeta{color:var(--muted);font-size:12px;margin-top:8px}

    .hide{display:none}

    .warn{
      background:rgba(255, 237, 213, .10);
      border:1px solid rgba(254, 215, 170, .42);
      color:#ffd3b0;
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      line-height:1.35
    }
    .ok{
      background:rgba(16,185,129,.10);
      border:1px solid rgba(167,243,208,.28);
      color:#c6ffe9;
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      line-height:1.35
    }

    /* RIGHT COLUMN: PROMO AD */
    .sideCard{position:sticky;top:92px}
    @media(max-width:980px){.sideCard{position:static}}

    .promoTop{
      display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.82);
      font-weight:900;
      font-size:12px;
    }
    .price{
      font-weight:1000;
      font-size:22px;
      letter-spacing:-.2px;
      color:#c6ffe9;
    }
    .price small{
      font-size:12px;
      color:rgba(255,255,255,.68);
      font-weight:900;
      margin-left:6px;
    }
    .promoH{
      margin-top:12px;
      font-size:22px;
      font-weight:1000;
      letter-spacing:-.2px;
      line-height:1.15;
    }
    .promoP{margin-top:8px;color:rgba(255,255,255,.72);line-height:1.5}
    .promoList{margin-top:14px;display:grid;gap:10px}
    .promoItem{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.10);
    }
    .tick{
      width:22px;height:22px;border-radius:8px;
      display:inline-flex;align-items:center;justify-content:center;
      background:rgba(110,231,183,.14);
      border:1px solid rgba(110,231,183,.28);
      color:#c6ffe9;
      font-weight:1000;
      flex:0 0 auto;
      margin-top:1px;
    }
    .promoItem b{display:block;font-weight:1000}
    .promoCta{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
    .promoFoot{margin-top:12px;color:rgba(255,255,255,.60);font-size:12px;line-height:1.35}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<header>
  <div class="h">
    <a class="brand" href="index.html" aria-label="endmysub home">
      <img class="logo" src="endmysublogo.png" alt="endmysub logo">
      <span class="name">endmysub</span>
    </a>

    <div class="right">
      <button id="btnLogout" class="btn hide" type="button">Logout</button>
      <a class="btn" href="cancel.html">Cancel</a>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="pageGrid">
    <!-- LEFT -->
    <div class="leftCol">
      <div class="card">
        <h1>Customer Reviews</h1>
        <p class="sub">Login required to post reviews. Status/errors are shown below.</p>

        <div id="statusBox" class="ok" style="margin-top:12px">Ready.</div>

        <!-- LOGIN BOX (STACKED) -->
        <div id="loginBox" class="grid">
          <div class="card" style="box-shadow:none;border-radius:14px">
            <h2 style="font-size:18px">Login / Sign up</h2>
            <p class="muted" style="margin-top:6px">Use email + password.</p>

            <label>Email</label>
            <input id="authEmail" type="email" placeholder="you@email.com">

            <label>Password</label>
            <input id="authPass" type="password" placeholder="••••••••">

            <div class="row">
              <button class="btn primary" id="btnLogin" type="button">Login</button>
              <button class="btn" id="btnSignup" type="button">Sign up</button>
            </div>

            <div class="muted" id="authMsg" style="margin-top:10px"></div>
          </div>

          <div class="card" style="box-shadow:none;border-radius:14px">
            <div class="warn">
              New reviews are marked as “pending” until approved.
            </div>
            <div class="muted" style="margin-top:10px">
              If you see “Failed to fetch”, open via Live Server (http://...), not file://
            </div>
          </div>
        </div>

        <!-- APP BOX -->
        <div id="appBox" class="hide">
          <div class="stat">
            <div class="pill" id="avgPill">Avg: —</div>
            <div class="pill" id="countPill">Reviews: —</div>
            <div class="pill" id="mePill">You: —</div>
          </div>

          <div class="grid" style="margin-top:14px">
            <div class="card" style="box-shadow:none;border-radius:14px">
              <h2 style="font-size:18px">Write a review</h2>

              <label>Display name</label>
              <input id="displayName" type="text" placeholder="First name or alias">

              <label>Rating</label>
              <select id="rating">
                <option value="5">5 – Excellent</option>
                <option value="4">4 – Good</option>
                <option value="3">3 – OK</option>
                <option value="2">2 – Bad</option>
                <option value="1">1 – Very bad</option>
              </select>

              <label>Title</label>
              <input id="title" type="text" placeholder="Short summary">

              <label>Review</label>
              <textarea id="body" placeholder="What was your experience?"></textarea>

              <div class="row">
                <button class="btn primary" id="btnPost" type="button">Post review</button>
                <span class="muted" id="postMsg"></span>
              </div>

              <div class="muted" style="margin-top:10px">
                Note: Your review may be pending until approved.
              </div>
            </div>

            <div class="card" style="box-shadow:none;border-radius:14px">
              <h2 style="font-size:18px">Latest reviews</h2>

              <label>Filter</label>
              <select id="filter">
                <option value="all">All (approved + your pending)</option>
                <option value="approved">Approved only</option>
                <option value="mine">My reviews</option>
              </select>

              <div class="list" id="list"></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT: PROMO -->
    <aside class="rightCol">
      <div class="card sideCard">
        <div class="promoTop">
          <span class="badge">endmysub · Kündigungsservice</span>
          <div class="price">22,00 €<small>einmalig</small></div>
        </div>

        <div class="promoH">Kündigung ohne Stress.</div>
        <div class="promoP">
          Du gibst die Daten an. endmysub übernimmt Kündigung + Bestätigung.
        </div>

        <div class="promoList">
          <div class="promoItem"><span class="tick">✓</span><div><b>Kein Abo</b><div class="muted">Einmal zahlen. Keine Folgekosten.</div></div></div>
          <div class="promoItem"><span class="tick">✓</span><div><b>Bestätigung inklusive</b><div class="muted">Nachweis/Status-Update sobald verfügbar.</div></div></div>
          <div class="promoItem"><span class="tick">✓</span><div><b>Unabhängig</b><div class="muted">Kein Bezug zu den Anbietern. Auftrag in deinem Namen.</div></div></div>
          <div class="promoItem"><span class="tick">✓</span><div><b>Schneller Ablauf</b><div class="muted">Weniger Hin und Her. Klare Schritte.</div></div></div>
        </div>

        <div class="promoCta">
          <a class="btn primary" href="cancel.html">Jetzt kündigen</a>
          <a class="btn" href="index.html#start">Startseite</a>
        </div>

        <div class="promoFoot">
          Unabhängiger Service. Keine Rechtsberatung. Keine Verbindung zu den Anbietern.
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
  // ====== SUPABASE CONFIG (SET) ======
  const SUPABASE_URL = "https://babacmszcumkgzyzidnh.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhYmFjbXN6Y3Vta2d6eXppZG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MDU4NTAsImV4cCI6MjA4NDM4MTg1MH0.rRhi17MQIlE-5iJQDSYu9CENxvaHhbFyHhSct_x-QaY";
  // ===================================

  const statusBox = document.getElementById("statusBox");
  const loginBox = document.getElementById("loginBox");
  const appBox = document.getElementById("appBox");
  const btnLogout = document.getElementById("btnLogout");
  const authMsg = document.getElementById("authMsg");
  const postMsg = document.getElementById("postMsg");

  const btnLogin = document.getElementById("btnLogin");
  const btnSignup = document.getElementById("btnSignup");
  const btnPost = document.getElementById("btnPost");
  const filterEl = document.getElementById("filter");

  function setStatusOk(msg){ statusBox.className = "ok"; statusBox.textContent = msg; }
  function setStatusWarn(msg){ statusBox.className = "warn"; statusBox.textContent = msg; }

  function setBusy(on){
    btnLogin.disabled = on;
    btnSignup.disabled = on;
    if (btnPost) btnPost.disabled = on;
  }

  function setAuthedUI(user){
    const on = !!user;
    loginBox.classList.toggle("hide", on);
    appBox.classList.toggle("hide", !on);
    btnLogout.classList.toggle("hide", !on);
    const me = document.getElementById("mePill");
    if (me) me.textContent = "You: " + (user?.email || "—");
  }

  function stars(n){
    const full = "★★★★★";
    const empty = "☆☆☆☆☆";
    return full.slice(0,n) + empty.slice(0, 5-n);
  }

  function fmtDate(ts){
    try{ return new Date(ts).toLocaleString(); }catch{ return ts; }
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  if (!window.supabase){
    setStatusWarn("Supabase library not loaded. Check internet or CDN blocked.");
  }

  const sb = window.supabase ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON) : null;

  async function refreshAuth(){
    if (!sb) return;
    try{
      // getSession is reliable for “nothing happens” cases (reads local session)
      const { data, error } = await sb.auth.getSession();
      if (error) authMsg.textContent = error.message;
      const user = data?.session?.user || null;
      setAuthedUI(user);

      if (user){
        setStatusOk("Logged in: " + user.email);
        await loadReviews();
      } else {
        setStatusOk("Ready.");
      }
    } catch (e){
      setStatusWarn("Failed to fetch. Use Live Server (http://...), not file://");
    }
  }

  btnLogin.addEventListener("click", async () => {
    if (!sb) return;
    authMsg.textContent = "";
    setBusy(true);
    setStatusOk("Logging in...");

    const email = document.getElementById("authEmail").value.trim();
    const password = document.getElementById("authPass").value;

    try{
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error){
        authMsg.textContent = error.message;
        setStatusWarn(error.message);
      } else {
        setStatusOk("Login success.");
        setAuthedUI(data?.user || null);
        await refreshAuth();
      }
    } catch (e){
      setStatusWarn("Failed to fetch. Use Live Server (http://...), not file://");
    } finally {
      setBusy(false);
    }
  });

  btnSignup.addEventListener("click", async () => {
    if (!sb) return;
    authMsg.textContent = "";
    setBusy(true);
    setStatusOk("Creating account...");

    const email = document.getElementById("authEmail").value.trim();
    const password = document.getElementById("authPass").value;

    try{
      const { error } = await sb.auth.signUp({ email, password });
      if (error){
        authMsg.textContent = error.message;
        setStatusWarn(error.message);
      } else {
        authMsg.textContent = "Account created. Login now.";
        setStatusOk("Account created. Login now.");
      }
    } catch (e){
      setStatusWarn("Failed to fetch. Use Live Server (http://...), not file://");
    } finally {
      setBusy(false);
    }
  });

  btnLogout.addEventListener("click", async () => {
    if (!sb) return;
    setBusy(true);
    try{
      await sb.auth.signOut();
      setStatusOk("Logged out.");
      await refreshAuth();
    } finally {
      setBusy(false);
    }
  });

  filterEl.addEventListener("change", () => loadReviews());

  btnPost.addEventListener("click", async () => {
    if (!sb) return;
    postMsg.textContent = "";
    setBusy(true);

    const { data: s } = await sb.auth.getSession();
    const user = s?.session?.user;
    if (!user){ setStatusWarn("Not logged in."); setBusy(false); return; }

    const display_name = document.getElementById("displayName").value.trim() || "Customer";
    const rating = parseInt(document.getElementById("rating").value, 10);
    const title = document.getElementById("title").value.trim();
    const body = document.getElementById("body").value.trim();

    if (!title || !body) {
      postMsg.textContent = "Title and review text are required.";
      setStatusWarn("Title and review text are required.");
      setBusy(false);
      return;
    }

    try{
      const payload = { user_id: user.id, display_name, rating, title, body, approved: false };
      const { error } = await sb.from("reviews").insert(payload);

      if (error){
        postMsg.textContent = error.message;
        setStatusWarn(error.message);
      } else {
        postMsg.textContent = "Posted. Pending approval.";
        setStatusOk("Posted. Pending approval.");
        document.getElementById("title").value = "";
        document.getElementById("body").value = "";
        await loadReviews();
      }
    } finally {
      setBusy(false);
    }
  });

  async function loadReviews(){
    if (!sb) return;

    const filter = document.getElementById("filter").value;
    const list = document.getElementById("list");
    list.innerHTML = "";

const { data: s } = await sb.auth.getSession();
const user = s?.session?.user;

if (!user){
  list.innerHTML = `<div class="warn">Not logged in.</div>`;
  return;
}

let q = sb.from("reviews")
  .select("id,user_id,display_name,rating,title,body,created_at,approved")
  .order("created_at", { ascending: false })
  .limit(50);

if (filter === "approved") {
  q = q.eq("approved", true);
}

if (filter === "mine") {
  q = q.eq("user_id", user.id);
}

if (filter === "all") {
  q = q.or(`approved.eq.true,user_id.eq.${user.id}`);
}

const { data, error } = await q;


    if (error) {
      list.innerHTML = `<div class="warn">${escapeHtml(error.message)}</div>`;
      setStatusWarn(error.message);
      return;
    }

    const reviews = data || [];
    const approvedOnly = reviews.filter(r => r.approved);

    const avg = approvedOnly.length
      ? (approvedOnly.reduce((a,r)=>a + r.rating, 0) / approvedOnly.length).toFixed(1)
      : "—";

    document.getElementById("avgPill").textContent = "Avg: " + avg;
    document.getElementById("countPill").textContent = "Reviews: " + approvedOnly.length;

    for (const r of reviews) {
      const pending = !r.approved;
      const el = document.createElement("div");
      el.className = "rev";
      el.innerHTML = `
        <div class="revTop">
          <div>
            <div class="stars">${stars(r.rating)} <span style="font-weight:700;color:${pending ? "#ffd3b0" : "#a9b4dd"};font-size:12px">${pending ? "(pending)" : ""}</span></div>
            <div class="revTitle">${escapeHtml(r.title)}</div>
          </div>
          <div class="revMeta">${escapeHtml(r.display_name)} · ${escapeHtml(fmtDate(r.created_at))}</div>
        </div>
        <div class="revBody">${escapeHtml(r.body)}</div>
      `;
      list.appendChild(el);
    }

    if (reviews.length === 0) {
      list.innerHTML = `<div class="muted">No reviews yet.</div>`;
    }
  }

  if (sb){
    // ensure UI updates even if auth state changes without manual refresh
    sb.auth.onAuthStateChange((_event, session) => {
      setAuthedUI(session?.user || null);
    });

    setStatusOk("Ready.");
    refreshAuth();
  }
</script>
</body>
</html>
